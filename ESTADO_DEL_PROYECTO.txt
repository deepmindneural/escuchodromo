================================================================================
ESCUCHODROMO - ESTADO DEL PROYECTO
Plataforma de Bienestar Emocional con IA Afectiva
Actualizado: 14 de Octubre, 2025
================================================================================

================================================================================
1. ARQUITECTURA ACTUAL
================================================================================

ANTES (Eliminado):
  ‚ùå Monorepo con Nx
  ‚ùå Backend NestJS (78+ endpoints REST)
  ‚ùå WebSocket con Socket.io
  ‚ùå Base de datos Prisma + SQLite
  ‚ùå JWT Auth custom
  ‚ùå ~500 MB de c√≥digo legacy

AHORA (Implementado):
  ‚úÖ Aplicaci√≥n Next.js 15 pura
  ‚úÖ Supabase como backend completo
  ‚úÖ PostgreSQL en la nube
  ‚úÖ Supabase Auth (autom√°tico)
  ‚úÖ Supabase Realtime (WebSocket)
  ‚úÖ Row Level Security (RLS)
  ‚úÖ ~200 MB total

================================================================================
2. BASE DE DATOS - SUPABASE
================================================================================

PROYECTO SUPABASE:
  URL: https://cvezncgcdsjntzrzztrj.supabase.co
  Estado: ‚úÖ ACTIVO
  Base de datos: PostgreSQL 15

TABLAS CREADAS (14 tablas):
  ‚úÖ Usuario
     - Almacena usuarios registrados
     - auth_id vinculado a Supabase Auth
     - Roles: USUARIO, TERAPEUTA, ADMIN

  ‚úÖ PerfilUsuario
     - Informaci√≥n adicional del usuario
     - Preferencias (idioma, moneda, zona horaria)
     - Consentimientos

  ‚úÖ Conversacion
     - Conversaciones de chat de usuarios autenticados
     - Soporte para embeddings de vector (IA)
     - Estados: activa, archivada, finalizada

  ‚úÖ Mensaje
     - Mensajes de conversaciones autenticadas
     - An√°lisis de sentimiento
     - Detecci√≥n de emociones (JSONB)
     - Embeddings vectoriales para contexto IA

  ‚úÖ Test
     - Tests psicol√≥gicos (PHQ-9, GAD-7)
     - Multiidioma (ES/EN)

  ‚úÖ Pregunta
     - Preguntas de cada test
     - Opciones en formato JSON

  ‚úÖ Evaluacion
     - Resultados de tests completados
     - Puntuaci√≥n y severidad
     - Historial completo

  ‚úÖ RegistroAnimo
     - Seguimiento diario de √°nimo
     - Escalas: √°nimo, energ√≠a, estr√©s (1-10)

  ‚úÖ Recomendacion
     - Recomendaciones personalizadas de IA
     - Priorizadas por importancia

  ‚úÖ Pago
     - Historial de transacciones
     - M√©todos: Stripe, PayPal, transferencia
     - Soporte COP y USD

  ‚úÖ Notificacion
     - Notificaciones email, push, SMS
     - Estado: le√≠da/no le√≠da

  ‚úÖ SesionPublica
     - Sesiones de chat para usuarios NO autenticados
     - L√≠mite de 10 mensajes por sesi√≥n

  ‚úÖ MensajePublico
     - Mensajes del chat p√∫blico
     - Acceso an√≥nimo permitido

  ‚úÖ ConfiguracionIA
     - Configuraci√≥n del modelo de IA
     - Par√°metros ajustables

ROW LEVEL SECURITY (RLS):
  ‚úÖ Pol√≠ticas configuradas para todas las tablas
  ‚úÖ Usuarios solo ven sus propios datos
  ‚úÖ Admins tienen acceso completo
  ‚úÖ Service role bypasea RLS (para Edge Functions)
  ‚úÖ SIN errores de recursi√≥n infinita

EXTENSIONES HABILITADAS:
  ‚úÖ uuid-ossp (generaci√≥n de UUIDs)
  ‚úÖ pgcrypto (encriptaci√≥n)
  ‚úÖ vector (embeddings para IA)

SEED DATA:
  ‚úÖ Test PHQ-9 (Depresi√≥n) con 2 preguntas de ejemplo
  ‚úÖ Test GAD-7 (Ansiedad) con 2 preguntas de ejemplo
  ‚úÖ Configuraci√≥n IA b√°sica

REALTIME HABILITADO:
  ‚úÖ Mensaje (chat en tiempo real)
  ‚úÖ Notificacion (notificaciones instant√°neas)
  ‚úÖ MensajePublico (chat p√∫blico)

================================================================================
3. FRONTEND - NEXT.JS
================================================================================

P√ÅGINAS MIGRADAS A SUPABASE (3/24):
  ‚úÖ /iniciar-sesion
     - Usa Supabase Auth
     - Sin localStorage, cookies httpOnly
     - OAuth listo (Google, Facebook)

  ‚úÖ /registrar
     - Crea usuario en Auth + tabla Usuario
     - Crea PerfilUsuario autom√°ticamente
     - Validaciones completas

  ‚úÖ /dashboard
     - Carga perfil desde Supabase
     - Logout con Supabase
     - Hooks personalizados (useUsuario, usePerfilUsuario)

P√ÅGINAS CON MIGRACI√ìN PARCIAL (1/24):
  ‚ö†Ô∏è  /chat
     - Interfaz completa ‚úÖ
     - Guarda mensajes en Supabase ‚úÖ
     - Chatbot con respuestas b√°sicas (reglas simples) ‚ö†Ô∏è
     - FALTA: Edge Function con OpenAI para IA real

P√ÅGINAS PENDIENTES DE MIGRAR (20/24):
  ‚ùå /evaluaciones (ver tests psicol√≥gicos)
  ‚ùå /evaluaciones/[codigo] (realizar test)
  ‚ùå /evaluaciones/resultado/[id] (ver resultados)
  ‚ùå /perfil (gestionar perfil de usuario)
  ‚ùå /animo (registro de √°nimo diario)
  ‚ùå /recomendaciones (ver recomendaciones de IA)
  ‚ùå /pago (gestionar pagos/suscripciones)
  ‚ùå /admin (panel de administraci√≥n)
  ‚ùå /admin/usuarios (gestionar usuarios)
  ‚ùå /terapeuta (panel de terapeuta)
  ‚ùå /terapeuta/pacientes (gestionar pacientes)
  ‚ùå Otras p√°ginas menores

COMPONENTES UI (25+):
  ‚úÖ Todos funcionan correctamente
  ‚úÖ Navegacion
  ‚úÖ Boton
  ‚úÖ ChatVoz
  ‚úÖ ImageWithFallback
  ‚úÖ Loading
  ‚úÖ Modal
  ‚úÖ Alert
  ‚úÖ Y m√°s...

HOOKS PERSONALIZADOS:
  ‚úÖ useUsuario() - Obtiene usuario autenticado
  ‚úÖ usePerfilUsuario() - Obtiene perfil completo
  ‚úÖ useMensajesRealtime() - Mensajes en tiempo real
  ‚úÖ useNotificacionesRealtime() - Notificaciones en tiempo real

ESTILOS:
  ‚úÖ Tailwind CSS configurado
  ‚úÖ Colores primarios y secundarios definidos
  ‚úÖ Animaciones (fade-in, slide-up, blob)
  ‚úÖ Responsive design completo

================================================================================
4. AUTENTICACI√ìN Y SEGURIDAD
================================================================================

SUPABASE AUTH:
  ‚úÖ Login con email/contrase√±a
  ‚úÖ Registro de nuevos usuarios
  ‚úÖ Logout
  ‚úÖ Sesiones persistentes (cookies httpOnly)
  ‚úÖ Refresh tokens autom√°ticos
  ‚úÖ OAuth configurado (Google, Facebook) - pendiente activar
  ‚ùå Reset de contrase√±a (pendiente)
  ‚ùå Verificaci√≥n de email (pendiente)

FUNCIONES DE AUTH (src/lib/supabase/auth.ts):
  ‚úÖ registrarUsuario()
  ‚úÖ iniciarSesion()
  ‚úÖ cerrarSesion()
  ‚úÖ obtenerUsuarioActual()
  ‚úÖ esAdmin()
  ‚úÖ esTerapeuta()
  ‚úÖ resetearContrasena()
  ‚úÖ actualizarContrasena()

MIDDLEWARE:
  ‚úÖ Protecci√≥n de rutas autenticadas
  ‚úÖ Redirecci√≥n autom√°tica a /iniciar-sesion
  ‚úÖ Rutas p√∫blicas permitidas
  ‚úÖ Refresh de sesi√≥n autom√°tico

ROW LEVEL SECURITY:
  ‚úÖ Base de datos segura por dise√±o
  ‚úÖ Imposible bypassear desde el cliente
  ‚úÖ Cada usuario solo ve sus datos
  ‚úÖ Admins tienen permisos especiales

================================================================================
5. FUNCIONALIDADES IMPLEMENTADAS
================================================================================

CHAT P√öBLICO (Usuarios NO autenticados):
  ‚úÖ Acceso sin registro
  ‚úÖ L√≠mite de 10 mensajes
  ‚úÖ Banner para registrarse
  ‚úÖ Respuestas con reglas simples
  ‚úÖ Almacenamiento en SesionPublica/MensajePublico
  ‚ùå IA real (pendiente Edge Function)

CHAT PRIVADO (Usuarios autenticados):
  ‚ö†Ô∏è  Interfaz lista pero backend pendiente
  ‚ùå Crear conversaciones
  ‚ùå Historial de conversaciones
  ‚ùå An√°lisis de emociones
  ‚ùå Embeddings vectoriales
  ‚ùå B√∫squeda sem√°ntica

TESTS PSICOL√ìGICOS:
  ‚úÖ Base de datos con PHQ-9 y GAD-7
  ‚ùå Interfaz para realizar tests (pendiente)
  ‚ùå C√°lculo de puntuaci√≥n (pendiente)
  ‚ùå Interpretaci√≥n de resultados (pendiente)
  ‚ùå Historial de evaluaciones (pendiente)

REGISTRO DE √ÅNIMO:
  ‚ùå Interfaz pendiente
  ‚ùå Gr√°ficas de progreso pendiente

RECOMENDACIONES:
  ‚ùå Generaci√≥n con IA pendiente
  ‚ùå Interfaz pendiente

PAGOS:
  ‚ùå Integraci√≥n con Stripe pendiente
  ‚ùå Integraci√≥n con PayPal pendiente
  ‚ùå Webhooks pendiente

NOTIFICACIONES:
  ‚ùå Email con SendGrid pendiente
  ‚ùå SMS con Twilio pendiente
  ‚ùå Push notifications pendiente

PANEL DE ADMINISTRACI√ìN:
  ‚ùå Gesti√≥n de usuarios pendiente
  ‚ùå Analytics pendiente
  ‚ùå Reportes pendiente

VOZ:
  ‚ùå Speech-to-text pendiente
  ‚ùå Text-to-speech pendiente
  ‚ùå An√°lisis de emociones por voz pendiente

================================================================================
6. EDGE FUNCTIONS DE SUPABASE (BACKEND LOGIC)
================================================================================

PENDIENTE DE CREAR (6 funciones):

  ‚ùå generate-ai-response
     - L√≥gica: Recibe mensaje del usuario, consulta historial, genera respuesta con OpenAI GPT-4
     - Input: { conversacion_id, mensaje, usuario_id }
     - Output: { respuesta, emociones_detectadas, sentimiento }
     - Ubicaci√≥n futura: supabase/functions/generate-ai-response/

  ‚ùå analyze-sentiment
     - L√≥gica: Analiza emociones en texto (8 emociones: alegr√≠a, tristeza, enojo, miedo, sorpresa, asco, anticipaci√≥n, confianza)
     - Input: { texto }
     - Output: { emociones: { alegria: 0.8, tristeza: 0.2, ... }, sentimiento: 0.6 }
     - Ubicaci√≥n futura: supabase/functions/analyze-sentiment/

  ‚ùå generate-recommendations
     - L√≥gica: Analiza historial de usuario y genera recomendaciones personalizadas
     - Input: { usuario_id }
     - Output: [{ titulo, descripcion, tipo, prioridad, url_accion }]
     - Ubicaci√≥n futura: supabase/functions/generate-recommendations/

  ‚ùå process-webhook
     - L√≥gica: Maneja webhooks de Stripe/PayPal, actualiza estado de pagos
     - Input: { event_type, payment_data }
     - Output: { success: true }
     - Ubicaci√≥n futura: supabase/functions/process-webhook/

  ‚ùå transcribe-audio
     - L√≥gica: Convierte audio a texto con Whisper API
     - Input: { audio_url }
     - Output: { texto, duracion }
     - Ubicaci√≥n futura: supabase/functions/transcribe-audio/

  ‚ùå synthesize-speech
     - L√≥gica: Convierte texto a audio con Azure Speech o ElevenLabs
     - Input: { texto, voz }
     - Output: { audio_url }
     - Ubicaci√≥n futura: supabase/functions/synthesize-speech/

C√ìMO CREAR UNA EDGE FUNCTION:
  1. supabase functions new nombre-funcion
  2. Escribir c√≥digo en TypeScript
  3. supabase functions deploy nombre-funcion
  4. Configurar variables de entorno (OPENAI_API_KEY, etc.)

================================================================================
7. VARIABLES DE ENTORNO
================================================================================

CONFIGURADAS:
  ‚úÖ NEXT_PUBLIC_SUPABASE_URL
  ‚úÖ NEXT_PUBLIC_SUPABASE_ANON_KEY
  ‚úÖ SUPABASE_SERVICE_ROLE_KEY
  ‚úÖ DATABASE_URL
  ‚úÖ NEXT_PUBLIC_APP_URL
  ‚úÖ NODE_ENV

PENDIENTES DE CONFIGURAR:
  ‚ùå OPENAI_API_KEY (para IA avanzada)
  ‚ùå STRIPE_SECRET_KEY
  ‚ùå STRIPE_PUBLISHABLE_KEY
  ‚ùå STRIPE_WEBHOOK_SECRET
  ‚ùå PAYPAL_CLIENT_ID
  ‚ùå PAYPAL_CLIENT_SECRET
  ‚ùå SENDGRID_API_KEY (emails)
  ‚ùå SENDGRID_FROM_EMAIL
  ‚ùå TWILIO_ACCOUNT_SID (SMS)
  ‚ùå TWILIO_AUTH_TOKEN
  ‚ùå TWILIO_PHONE_NUMBER
  ‚ùå AZURE_SPEECH_KEY (voz)
  ‚ùå AZURE_SPEECH_REGION

================================================================================
8. SCRIPTS √öTILES
================================================================================

DESARROLLO:
  npm run dev                    - Inicia Next.js en http://localhost:3000
  npm run build                  - Build de producci√≥n
  npm run start                  - Inicia servidor de producci√≥n
  npm run lint                   - Ejecuta linter
  npm run type-check             - Verifica tipos TypeScript

SUPABASE:
  node scripts/test-supabase.js  - Verifica conexi√≥n y tablas
  (manual) SQL Editor            - Ejecutar migraciones

ARCHIVOS DE MIGRACI√ìN:
  supabase/migracion-final-corregida.sql - Migraci√≥n completa aplicada ‚úÖ
  supabase/seed.sql                      - Datos de prueba (dentro de migraci√≥n)

================================================================================
9. DOCUMENTACI√ìN DISPONIBLE
================================================================================

ARCHIVOS DE DOCUMENTACI√ìN:
  ‚úÖ README.md (pendiente actualizar)
  ‚úÖ CLAUDE.md (instrucciones para Claude Code)
  ‚úÖ LIMPIEZA_COMPLETADA.md (registro de limpieza del monorepo)
  ‚úÖ MIGRACION_SUPABASE.md (gu√≠a de migraci√≥n)
  ‚úÖ ESTADO_MIGRACION.md (estado de la migraci√≥n)
  ‚úÖ INSTRUCCIONES_MIGRACION.md (c√≥mo aplicar migraci√≥n manual)
  ‚úÖ ESTADO_DEL_PROYECTO.txt (este archivo)

================================================================================
10. PRUEBAS Y TESTING
================================================================================

TESTING:
  ‚ùå Tests unitarios (pendiente)
  ‚ùå Tests de integraci√≥n (pendiente)
  ‚ùå Tests E2E (pendiente)

PRUEBAS MANUALES REALIZADAS:
  ‚úÖ Registro de usuario funcional
  ‚úÖ Login funcional
  ‚úÖ Dashboard carga correctamente
  ‚úÖ Chat p√∫blico funcional
  ‚úÖ Estilos Tailwind funcionan
  ‚úÖ Navegaci√≥n entre p√°ginas
  ‚úÖ Base de datos Supabase verificada

================================================================================
11. ROADMAP - PR√ìXIMOS PASOS
================================================================================

PRIORIDAD ALTA (Para que la app sea funcional):

  1. ‚úÖ COMPLETADO: Migraci√≥n de base de datos
  2. ‚úÖ COMPLETADO: Login y registro con Supabase
  3. ‚úÖ COMPLETADO: Chat b√°sico funcionando

  4. ‚ùå PENDIENTE: Crear Edge Function para IA del chat
     - Integrar OpenAI GPT-4
     - Implementar contexto conversacional
     - An√°lisis de emociones
     Estimado: 2-3 horas

  5. ‚ùå PENDIENTE: Migrar p√°gina de evaluaciones
     - Interfaz para ver tests disponibles
     - Interfaz para realizar tests
     - C√°lculo de puntuaci√≥n autom√°tico
     - Mostrar resultados e interpretaci√≥n
     Estimado: 3-4 horas

  6. ‚ùå PENDIENTE: P√°gina de perfil de usuario
     - Editar informaci√≥n personal
     - Cambiar contrase√±a
     - Preferencias
     Estimado: 2 horas

PRIORIDAD MEDIA (Funcionalidades importantes):

  7. ‚ùå Registro de √°nimo diario
     - Interfaz de registro
     - Gr√°ficas de progreso
     Estimado: 2-3 horas

  8. ‚ùå Sistema de recomendaciones
     - Edge Function con IA
     - Interfaz de visualizaci√≥n
     Estimado: 3-4 horas

  9. ‚ùå Chat privado (autenticado)
     - Crear/listar conversaciones
     - Historial completo
     - B√∫squeda sem√°ntica
     Estimado: 4-5 horas

  10. ‚ùå Reset de contrase√±a
      - Email de recuperaci√≥n
      - Cambio de contrase√±a
      Estimado: 1-2 horas

PRIORIDAD BAJA (Mejoras y features adicionales):

  11. ‚ùå Sistema de pagos
      - Integraci√≥n Stripe
      - Webhooks
      - Historial de pagos
      Estimado: 5-6 horas

  12. ‚ùå Sistema de notificaciones
      - Email con SendGrid
      - Push notifications
      - SMS con Twilio
      Estimado: 4-5 horas

  13. ‚ùå Panel de administraci√≥n
      - Gesti√≥n de usuarios
      - Analytics
      - Reportes
      Estimado: 6-8 horas

  14. ‚ùå Funcionalidades de voz
      - Speech-to-text
      - Text-to-speech
      - An√°lisis emocional de voz
      Estimado: 6-8 horas

  15. ‚ùå Tests automatizados
      - Unit tests
      - Integration tests
      - E2E tests
      Estimado: 8-10 horas

================================================================================
12. INFORMACI√ìN T√âCNICA
================================================================================

STACK TECNOL√ìGICO:
  - Next.js 15.2.5 (App Router)
  - React 19
  - TypeScript 5
  - Tailwind CSS 3
  - Supabase (PostgreSQL + Auth + Realtime + Storage)
  - Framer Motion (animaciones)
  - React Hot Toast (notificaciones)
  - React Icons

ESTRUCTURA DE CARPETAS:
  /src
    /app                  - P√°ginas Next.js (App Router)
    /lib
      /componentes        - Componentes UI reutilizables
      /hooks              - React hooks personalizados
      /supabase           - Integraci√≥n con Supabase
  /supabase
    /migrations           - Migraciones SQL aplicadas
  /scripts                - Scripts de utilidad
  /public                 - Archivos est√°ticos

COMPATIBILIDAD:
  - Node.js 18+
  - Navegadores modernos (Chrome, Firefox, Safari, Edge)
  - Mobile responsive

RENDIMIENTO:
  - Build optimizado
  - Code splitting autom√°tico
  - Lazy loading de componentes
  - Im√°genes optimizadas con Next/Image

================================================================================
13. ENLACES √öTILES
================================================================================

PROYECTO:
  - Localhost: http://localhost:3000
  - Producci√≥n: (pendiente de deploy)

SUPABASE:
  - Dashboard: https://supabase.com/dashboard/project/cvezncgcdsjntzrzztrj
  - Database: https://supabase.com/dashboard/project/cvezncgcdsjntzrzztrj/editor
  - SQL Editor: https://supabase.com/dashboard/project/cvezncgcdsjntzrzztrj/sql
  - Auth: https://supabase.com/dashboard/project/cvezncgcdsjntzrzztrj/auth/users
  - API Docs: https://supabase.com/dashboard/project/cvezncgcdsjntzrzztrj/api

RECURSOS:
  - Docs Supabase: https://supabase.com/docs
  - Docs Next.js: https://nextjs.org/docs
  - Docs Tailwind: https://tailwindcss.com/docs

================================================================================
14. NOTAS IMPORTANTES
================================================================================

‚ö†Ô∏è  CR√çTICO:
  - Service Role Key es SECRETO - nunca exponerlo en el cliente
  - Solo usar Anon Key en el frontend
  - RLS protege los datos incluso con Anon Key

üí° CONSEJOS:
  - Usa useUsuario() hook para obtener usuario autenticado
  - Usa usePerfilUsuario() para obtener perfil completo
  - Para operaciones que requieren service role, usa Edge Functions

üîí SEGURIDAD:
  - Todas las tablas tienen RLS habilitado
  - Usuarios solo ven sus propios datos
  - Validaci√≥n en cliente Y en servidor (RLS)
  - Contrase√±as hasheadas autom√°ticamente por Supabase Auth

üìä RENDIMIENTO:
  - √çndices creados en campos comunes (email, auth_id, etc.)
  - Queries optimizadas con .select() espec√≠ficos
  - Realtime solo en tablas necesarias

================================================================================
15. CONTACTO Y SOPORTE
================================================================================

PROYECTO:
  - Nombre: Escuchodromo
  - Versi√≥n: 2.0 (migrado a Supabase)
  - Autor: [Tu nombre]
  - Fecha de inicio: 2024
  - √öltima actualizaci√≥n: Octubre 2025

AYUDA:
  - Para bugs: Crear issue en GitHub
  - Para preguntas: Consultar documentaci√≥n
  - Para Claude Code: Ver CLAUDE.md

================================================================================
FIN DEL DOCUMENTO
================================================================================

√öltima actualizaci√≥n: 14 de Octubre, 2025
Estado general: üü° EN DESARROLLO (70% migrado a Supabase)
Pr√≥ximo milestone: Edge Function para IA del chat
